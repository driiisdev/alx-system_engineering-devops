#!/usr/bin/env bash

# Check if script is being run as root
if [ "$EUID" -ne 0 ]; then
    echo "This script must be run as root."
    exit 1
fi

# Create nginx user if it doesn't exist
if ! id "nginx" &> /dev/null; then
    useradd -r -s /sbin/nologin nginx
fi

# Install nginx (if not already installed)
if ! command -v nginx &> /dev/null; then
    # Download and install nginx
    wget https://nginx.org/download/nginx-1.21.3.tar.gz
    tar -xvf nginx-1.21.3.tar.gz
    cd nginx-1.21.3

    # Configure, make, and install nginx
    ./configure --user=nginx --group=nginx --prefix=/usr/local/nginx --with-http_ssl_module
    make
    make install

    # Clean up
    cd ..
    rm -rf nginx-1.21.3 nginx-1.21.3.tar.gz
fi

# Configure nginx to listen on all IPs on port 8080
echo "
server {
    listen 8080;
    server_name _;

    location / {
        root /usr/local/nginx/html;
        index index.html;
    }
}" > /usr/local/nginx/conf/nginx.conf

# Start nginx
/usr/local/nginx/sbin/nginx

